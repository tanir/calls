<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="stylesheet" href="/common.css" />
  <title>–ö–æ–º–Ω–∞—Ç–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞</title>
  <style>
    :root{
      color-scheme: light dark;
      --header-h:56px; --controls-h:72px; --pad:10px;

      /* –®–ò–†–ò–ù–ê –ø—Ä–µ–≤—å—é –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π, –í–´–°–û–¢–ê —É–≤–µ–ª–∏—á–µ–Ω–∞ –≤ 2 —Ä–∞–∑–∞:
         –≤—ã—Å–æ—Ç–∞ = —à–∏—Ä–∏–Ω–∞ * 1.125 (—Ç.–∫. (9/16)*2 = 1.125) */
      --pip-w-desktop:180px;
      --pip-w-mobile:120px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0b0c;color:#fff}

    header{
      position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;justify-content:space-between;
      height:var(--header-h);padding:8px max(10px,env(safe-area-inset-right)) 8px max(10px,env(safe-area-inset-left));
      background:#111317;border-bottom:1px solid #ffffff14;
    }
    .roomid{font-size:.95rem;opacity:.85;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .actions{display:none}

    button{
      background:#1f232a;color:#fff;border:1px solid #ffffff22;padding:10px 12px;border-radius:12px;cursor:pointer;min-height:44px;
      touch-action:manipulation;display:inline-flex;align-items:center;gap:8px
    }
    button:active{transform:translateY(1px)}
    /* .btn-icon svg sizing moved to common.css */
    .danger{background:#b3261e;border-color:#b3261e}

    /* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ on/off */
    .icon.off-ico{display:none}
    .btn-icon.off .on-ico{display:none}
    .btn-icon.off .off-ico{display:inline}

    .layout{display:grid;grid-template-columns:1fr;gap:10px;padding:var(--pad);min-height:auto;padding-bottom:calc(var(--controls-h)+8px)}
    .video-wrap{
      position:relative;background:#0e1014;border:1px solid #ffffff14;border-radius:0;
      display:grid;place-items:center;overflow:hidden;min-height:240px;
      height:calc(var(--vh,100svh) - var(--header-h) - var(--controls-h) - env(safe-area-inset-top));
      border-left:0;border-right:0
    }

    /* –í–∏–¥–µ–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —É–¥–∞–ª—ë–Ω–Ω–æ–µ ‚Äî –±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ */
    video{width:100%;height:100%;object-fit:cover}
    #remoteVideo{object-fit:contain;background:#000}

    /* –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–≤—å—é: —à–∏—Ä–∏–Ω–∞ –∫–∞–∫ –ø—Ä–µ–∂–¥–µ, –≤—ã—Å–æ—Ç–∞ = —à–∏—Ä–∏–Ω–∞ * 1.125 (–≤ 2 —Ä–∞–∑–∞ –≤—ã—à–µ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π 16:9) */
    .local{
      position:absolute;right:12px;bottom:12px;z-index:4;
      width:var(--pip-w-mobile) !important;
      height:calc(var(--pip-w-mobile) * 1.125) !important;
      object-fit:cover;border:1px solid #ffffff2a;border-radius:12px;overflow:hidden;
      box-shadow:0 8px 30px #00000066;pointer-events:none;background:#000
    }

    /* –û–≤–µ—Ä–ª–µ–∏ */
    .overlay{position:absolute;inset:0;display:grid;place-items:center;background:#0006;backdrop-filter:blur(2px)}
    .overlay.hidden{display:none}
    .overlay button{font-size:1rem;padding:14px 18px;border-radius:14px}

    /* –ü–ª–∞—à–∫–∞ ¬´–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω¬ª */
    .mic-hint{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      background:#b3261ee6;color:#fff;border:1px solid #ffffff44;border-radius:12px;
      padding:8px 12px;font-weight:600;z-index:6;backdrop-filter:saturate(1.2) blur(2px)
    }
    .mic-hint.hidden{display:none}

    .sidebar{display:grid;grid-auto-rows:min-content;gap:10px;min-height:0}
    .card{padding:12px;background:#111317;border:1px solid #ffffff14;border-radius:14px}
    .status{font-size:.95rem;opacity:.9}

    .controls{
      position:fixed;left:0;right:0;bottom:0;z-index:6;display:block;background:#111317cc;backdrop-filter:blur(10px);
      border-top:1px solid #ffffff22;padding:8px max(10px,env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) max(10px,env(safe-area-inset-left));
      height:var(--controls-h)
    }
    .controls .row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px}
    .controls button{width:100%}

    /* –£–±—Ä–∞–Ω–∞ —É–∑–∫–∞—è –ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ —Å—Ä–µ–¥–Ω–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    /* @media(max-width:1024px){.layout{grid-template-columns:1fr 260px}} */
    @media(max-width:900px){
      .sidebar{order:2}
      /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –ø—É—Å—Ç–æ–≥–æ –º–µ—Å—Ç–∞ */
      #hangupM{width:auto;justify-content:center;padding:12px;min-width:56px}
      header{border-radius:0}
      body{background:#0e1014}
    }

    button:focus-visible{outline:2px solid #7aa2ff;outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="roomid">–ö–æ–º–Ω–∞—Ç–∞: <span id="roomLabel"></span></div>
    <div class="actions">
      <button id="copyLink" class="btn-icon" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 0 0-7.07-7.07L10.5 5"/>
          <path d="M14 11a5 5 0 0 0-7.07 0L4.8 13.13a5 5 0 1 0 7.07 7.07L13.5 19"/>
        </svg>
        <span class="label">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
      </button>

      <button id="toggleCam" class="btn-icon" aria-pressed="true" aria-label="–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <path d="M17 9l5-3v12l-5-3z"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><path d="M3 7a2 2 0 0 1 2-2h7"/>
          <path d="M16 16H5a2 2 0 0 1-2-2V9"/><path d="M17 9l5-3v8"/>
        </svg>
        <span class="label">–ö–∞–º–µ—Ä–∞</span>
      </button>

      <button id="toggleMic" class="btn-icon" aria-pressed="true" aria-label="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><path d="M12 19v3"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10v2a7 7 0 0 0 10.5 6.1"/><path d="M12 19v3"/>
        </svg>
        <span class="label">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
      </button>

      <!-- ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª ‚Äî –¢–û–õ–¨–ö–û –∏–∫–æ–Ω–∫–∞, –±–µ–∑ –ø–æ–¥–ø–∏—Å–∏ -->
      <button id="hangup" class="danger btn-icon" aria-label="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.36a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.72-1.14a2 2 0 0 1 2.11-.45c.74.25 1.54.44 2.36.57A2 2 0 0 1 22 16.92z"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="layout">
    <section class="video-wrap" id="videoWrap">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" class="local" autoplay muted playsinline></video>

      <!-- –ü–ª–∞—à–∫–∞ ¬´–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω¬ª -->
      <div id="micHint" class="mic-hint hidden">–í–∫–ª—é—á–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω</div>

      <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –∞–≤—Ç–æ–ø–ª–µ—è (iOS/Safari) -->
      <div id="playOverlay" class="overlay hidden">
        <button id="startPlayback">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</button>
      </div>
    </section>
    
  </main>

  <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å (–º–æ–±–∏–ª—å–Ω–∞—è) ‚Äî —É –í–°–ï–• –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–ø–∏—Å–∏, –∫—Ä–æ–º–µ ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å¬ª -->
  <nav class="controls" role="navigation" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤–æ–Ω–∫–æ–º">
    <div class="row">
      <button id="copyLinkM" class="btn-icon" aria-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 0 0-7.07-7.07L10.5 5"/>
          <path d="M14 11a5 5 0 0 0-7.07 0L4.8 13.13a5 5 0 1 0 7.07 7.07L13.5 19"/>
        </svg>
        <span class="label">–°—Å—ã–ª–∫–∞</span>
      </button>
      <button id="toggleCamM" class="btn-icon" aria-pressed="true" aria-label="–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <path d="M17 9l5-3v12l-5-3z"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><path d="M3 7a2 2 0 0 1 2-2h7"/>
          <path d="M16 16H5a2 2 0 0 1-2-2V9"/><path d="M17 9l5-3–≤8"/>
        </svg>
        <span class="label">–ö–∞–º–µ—Ä–∞</span>
      </button>
      <button id="toggleMicM" class="btn-icon" aria-pressed="true" aria-label="–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><path d="M12 19v3"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10v2a7 7 0 0 0 10.5 6.1"/><path d="M12 19v3"/>
        </svg>
        <span class="label">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</span>
      </button>
      <button id="hangupM" class="danger btn-icon" aria-label="–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.36a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.72-1.14a2 2 0 0 1 2.11-.45c.74.25 1.54.44 2.36.57A2 2 0 0 1 22 16.92z"/>
        </svg>
      </button>
    </div>
  </nav>

  <script>
    /* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö */
    function setVh(){const h=(window.visualViewport?.height||window.innerHeight);document.documentElement.style.setProperty('--vh',h+'px')}
    setVh();window.addEventListener('resize',setVh);window.addEventListener('orientationchange',setVh);

    const qs=new URLSearchParams(location.search);
    let roomId=qs.get('room'); let token=qs.get('token');

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'video'
    roomType = qs.get('type') || 'video';
    console.log('üè† Room type:', roomType);

    const roomLabel=document.getElementById('roomLabel'); const statusEl=document.getElementById('status');
    const copyBtn=document.getElementById('copyLink'); const camBtn=document.getElementById('toggleCam'); const micBtn=document.getElementById('toggleMic'); const hangupBtn=document.getElementById('hangup');
    const copyBtnM=document.getElementById('copyLinkM'); const camBtnM=document.getElementById('toggleCamM'); const micBtnM=document.getElementById('toggleMicM'); const hangupBtnM=document.getElementById('hangupM');

    const localVideo=document.getElementById('localVideo'); const remoteVideo=document.getElementById('remoteVideo');
    const overlay=document.getElementById('playOverlay'); const startPlaybackBtn=document.getElementById('startPlayback');
    const micHint=document.getElementById('micHint');

    // –£–ø—Ä–æ—â–µ–Ω–æ: –∂–¥—ë–º room/token —Ç–æ–ª—å–∫–æ –∏–∑ query

    let ws,pc,localStream; let role='guest'; let isCamOn=true,isMicOn=true; let offerStarted=false;
    let relayMode=false; let iceRestartTried=false; let relaySwitchTried=false;
    let connectionTimer=null; let isRussianUser=false; let isSafari=false; let roomType='video';

    // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ STUN/TURN —Å–µ—Ä–≤–µ—Ä—ã –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –†–æ—Å—Å–∏–µ–π
    let iceServers = [
      // –û—Å–Ω–æ–≤–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã Google (–º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –†–§)
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'stun:stun1.l.google.com:19302' },
      { urls: 'stun:stun2.l.google.com:19302' },
      { urls: 'stun:stun3.l.google.com:19302' },
      { urls: 'stun:stun4.l.google.com:19302' },

      // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã
      { urls: 'stun:stun.stunprotocol.org:3478' },
      { urls: 'stun:stun.voxgratia.org:3478' },
      { urls: 'stun:stun.xten.com:3478' },
      { urls: 'stun:stun.sipnet.net:3478' },
      { urls: 'stun:stun.ideasip.com:3478' },
      { urls: 'stun:stun.iptel.org:3478' },
      { urls: 'stun:stun.softjoys.com:3478' },
      { urls: 'stun:stunserver.org:3478' },

      // TURN —Å–µ—Ä–≤–µ—Ä—ã (—Ä–∞–±–æ—Ç–∞—é—Ç –¥–∞–∂–µ —á–µ—Ä–µ–∑ NAT/firewall)
      { urls: 'turn:turn.bistri.com:80', username: 'homeo', credential: 'homeo' },
      { urls: 'turn:turn.anyfirewall.com:443?transport=tcp', username: 'webrtc', credential: 'webrtc' },
      { urls: 'turn:numb.viagenie.ca:3478', username: 'numb', credential: 'numbviagenie' },
      { urls: 'turn:turn01.hubl.in:3478', username: 'hubl', credential: 'hubl' },

      // –†–æ—Å—Å–∏–π—Å–∫–∏–µ TURN —Å–µ—Ä–≤–µ—Ä—ã (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
      { urls: 'turn:turn.russianvoicechat.com:3478', username: 'guest', credential: 'guest' },

      // –û—Å–Ω–æ–≤–Ω–æ–π TURN —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
      { urls: ['turn:64.226.121.112:3478'], username: 'webrtcuser', credential: '' }
    ];

    async function loadTurn(){
      try{
        const r=await fetch('/api/turn');
        if(r.ok){
          const d=await r.json();
          if(Array.isArray(d.iceServers)) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
            iceServers = [...iceServers, ...d.iceServers];
          }
        }
      }catch{}
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –†–æ—Å—Å–∏–∏
    function detectRussianUser(){
      const lang = navigator.language || navigator.userLanguage;
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      return lang.startsWith('ru') || timezone.includes('Moscow') || timezone.includes('Europe/Moscow');
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º Safari
    function detectSafari(){
      const ua = navigator.userAgent;
      return /^((?!chrome|android).)*safari/i.test(ua) || /Safari/i.test(navigator.vendor);
    }

    function setStatus(t){ if(statusEl) statusEl.textContent=t }
    function send(type,data){ws?.send(JSON.stringify({type,data,roomId,token}))}

    async function initMedia(){
      console.log('üé• initMedia called, isSafari:', isSafari);

      try {
        isSafari = detectSafari();

        if (isSafari) {
          console.log('üß≠ Safari detected, trying simplified access');
          setStatus('Safari –æ–±–Ω–∞—Ä—É–∂–µ–Ω ‚Äî –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞...');

          // –î–ª—è Safari –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
          console.log('üé• Requesting combined media access for Safari...');
          try {
            localStream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640, max: 1280 },
                height: { ideal: 480, max: 720 },
                facingMode: 'user'
              },
              audio: {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false
              }
            });
            console.log('‚úÖ Safari media access successful, tracks:', localStream.getTracks().length);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –∏ –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ
            const audioTracks = localStream.getAudioTracks();
            const videoTracks = localStream.getVideoTracks();

            console.log('üé§ Audio tracks:', audioTracks.length, 'üìπ Video tracks:', videoTracks.length);

            if (audioTracks.length > 0) {
              setStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –∫–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã');
            } else if (videoTracks.length > 0) {
              setStatus('–ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ (–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω)');
            } else {
              throw new Error('–ù–∏ –∞—É–¥–∏–æ, –Ω–∏ –≤–∏–¥–µ–æ —Ç—Ä–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            }

          } catch (safariError) {
            console.warn('‚ùå Safari media access failed:', safariError);

            // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ –¥–ª—è Safari
            try {
              console.log('üìπ Trying video-only access...');
              localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                  width: { ideal: 640 },
                  height: { ideal: 480 }
                },
                audio: false
              });
              console.log('‚úÖ Video-only access successful');
              setStatus('–ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ (–º–∏–∫—Ä–æ—Ñ–æ–Ω –æ—Ç–∫–ª—é—á–µ–Ω)');
            } catch (videoOnlyError) {
              console.error('‚ùå Video-only access also failed:', videoOnlyError);
              throw safariError; // –ë—Ä–æ—Å–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
            }
          }

        } else {
          console.log('üåê Non-Safari browser, using standard access');
          // –î–ª—è –¥—Ä—É–≥–∏—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥
          localStream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720 },
            audio: { echoCancellation: true, noiseSuppression: true }
          });
          console.log('‚úÖ Standard access successful, tracks:', localStream.getTracks().length);
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫ –≤ –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç (–µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if (localVideo && !roomType) { // roomType –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –≤–∏–¥–µ–æ-–∫–æ–º–Ω–∞—Ç
          console.log('üì∫ Setting video element srcObject');
          localVideo.srcObject = localStream;
        }

        console.log('üéâ Media initialization completed successfully');
        setStatus('–ú–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≥–æ—Ç–æ–≤—ã');

      } catch (error) {
        console.error('‚ùå Media access error:', error);
        console.error('Error name:', error.name);
        console.error('Error message:', error.message);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ–∑–º–æ–∂–Ω–æ –¥–æ—Å—Ç—É–ø —É–∂–µ –µ—Å—Ç—å, –Ω–æ –æ—à–∏–±–∫–∞ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
        if (localStream && localStream.getTracks().length > 0) {
          console.log('‚ö†Ô∏è  Stream exists but error occurred, tracks:', localStream.getTracks().length);
          const audioTracks = localStream.getAudioTracks().length;
          const videoTracks = localStream.getVideoTracks().length;
          console.log(`üé§ Audio: ${audioTracks}, üìπ Video: ${videoTracks}`);

          if (audioTracks > 0 || videoTracks > 0) {
            setStatus('–ú–µ–¥–∏–∞ –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
            return; // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
          }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è Safari
        if (isSafari) {
          console.log('üîç Checking Safari permissions...');
          try {
            const permissions = await navigator.permissions.query({ name: 'camera' });
            console.log('üìπ Camera permission:', permissions.state);
            const micPermissions = await navigator.permissions.query({ name: 'microphone' });
            console.log('üé§ Microphone permission:', micPermissions.state);
          } catch (permError) {
            console.log('‚ö†Ô∏è  Permissions API not available');
          }
        }

        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. ';

        if (error.name === 'NotAllowedError') {
          errorMessage += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
        } else if (error.name === 'NotFoundError') {
          errorMessage += '–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.';
        } else if (error.name === 'NotReadableError') {
          errorMessage += '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–∞–Ω—è—Ç—ã –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
        } else if (error.name === 'OverconstrainedError') {
          errorMessage += '–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.';
        } else {
          errorMessage += '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.';
        }

        alert(errorMessage);

        // –î–ª—è Safari –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        if (isSafari) {
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          let safariMessage = '–î–ª—è Safari:\n';

          if (isIOS) {
            safariMessage += '‚Ä¢ –í iOS Safari –∫–æ—Å–Ω–∏—Ç–µ—Å—å –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ"\n';
            safariMessage += '‚Ä¢ –ò–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Safari > –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å > –ö–∞–º–µ—Ä–∞/–ú–∏–∫—Ä–æ—Ñ–æ–Ω\n';
          } else {
            safariMessage += '‚Ä¢ –í –º–µ–Ω—é Safari –≤—ã–±–µ—Ä–∏—Ç–µ "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞"\n';
            safariMessage += '‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É\n';
          }

          safariMessage += '‚Ä¢ –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
          safariMessage += '\n\n–û—Ç–∫—Ä–æ–π—Ç–µ –ö–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (Cmd+Opt+C) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.';

          alert(safariMessage);

          // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
          const retryButton = document.createElement('button');
          retryButton.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞';
          retryButton.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 12px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10000;
          `;
          retryButton.onclick = async () => {
            retryButton.remove();
            try {
              await initMedia();
              if (typeof createPeer === 'function') {
                await createPeer();
              }
              setStatus('–ú–µ–¥–∏–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≥–æ—Ç–æ–≤—ã ‚Äî –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
            } catch (retryError) {
              console.error('Retry failed:', retryError);
              alert('–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
          };
          document.body.appendChild(retryButton);
        }

        throw error;
      }
    }

    function preferH264(pc){
      const caps=RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities('video');
      if(!caps||!caps.codecs) return;
      const h264=caps.codecs.filter(c=>(c.mimeType||'').toLowerCase()==='video/h264');
      if(!h264.length) return;
      const others=caps.codecs.filter(c=>(c.mimeType||'').toLowerCase()!=='video/h264');
      pc.getTransceivers().forEach(t=>{ if(t?.receiver?.track?.kind==='video'&&t.setCodecPreferences){ try{ t.setCodecPreferences([...h264,...others]) }catch{} }});
    }

    function ensurePlayback(){
      if (!remoteVideo) return; // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º

      const tryPlay=()=>{
        remoteVideo.volume = isSpeakerOn ? 1.0 : 0.0;
        remoteVideo.play().then(()=>{
          if (overlay) overlay.classList.add('hidden');
        }).catch((error)=>{
          console.log('Playback failed:', error);
          if (overlay) overlay.classList.remove('hidden');

          // –î–ª—è Safari –¥–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
          if (isSafari && startPlaybackBtn) {
            startPlaybackBtn.textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (Safari)';
            startPlaybackBtn.style.display = 'block';
          }
        });
      };

      // –î–ª—è Safari –¥–µ–ª–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø–æ–ø—ã—Ç–∫—É –ø–æ—Å–ª–µ user interaction
      if (isSafari) {
        const userInteractionHandler = () => {
          tryPlay();
        };

        document.addEventListener('touchstart', userInteractionHandler, { once: true });
        document.addEventListener('click', userInteractionHandler, { once: true });
      }

      tryPlay();
      if (remoteVideo) remoteVideo.addEventListener('loadedmetadata',tryPlay,{once:true});
      if (startPlaybackBtn) startPlaybackBtn.addEventListener('click',tryPlay);
      document.addEventListener('visibilitychange',()=>{ if(!document.hidden) tryPlay() })
    }

    function createPeer(){
      pc=new RTCPeerConnection({iceServers, iceTransportPolicy: relayMode?'relay':'all'});
      localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
      preferH264(pc);

      pc.ontrack=(ev)=>{
        const [stream]=ev.streams;
        if(stream && remoteVideo.srcObject!==stream){ remoteVideo.srcObject=stream; ensurePlayback(); }
      };
      pc.onicecandidate=(ev)=>{ if(ev.candidate) send('candidate',{candidate:ev.candidate}) };
      pc.oniceconnectionstatechange=async()=>{
        const s=pc.iceConnectionState;
        if(s==='failed'){
          setStatus('ICE failed ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å‚Ä¶');
          if(!iceRestartTried){
            try{
              iceRestartTried=true;
              const offer=await pc.createOffer({iceRestart:true});
              await pc.setLocalDescription(offer); send('offer',offer);
            }catch(e){ console.error('iceRestart',e); }
          } else if(!relaySwitchTried){
            relaySwitchTried=true;
            send('force-relay',{});
            switchToRelay();
          }
        }
      };
      pc.onconnectionstatechange=()=>{
        const s=pc.connectionState;
        if(s==='connected') {
          setStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
          if(connectionTimer) {
            clearTimeout(connectionTimer);
            connectionTimer = null;
          }
        }
        if(s==='disconnected'||s==='failed') setStatus('–°–≤—è–∑—å –ø–æ—Ç–µ—Ä—è–Ω–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.')
      };
    }

    async function start(){
      console.log('üöÄ Starting application...');
      roomLabel.textContent=roomId||'‚Äî';
      if(!roomId||!token){
        console.log('‚ùå Missing roomId or token');
        alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç room –∏–ª–∏ token.');
        location.href='/';
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º HTTPS –¥–ª—è Safari
      if (isSafari && location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.log('‚ùå Safari requires HTTPS');
        alert('Safari —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤–µ—Ä—Å–∏—é —Å–∞–π—Ç–∞.');
        return;
      }

      console.log('üîç Detecting user location...');
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º relay —Ä–µ–∂–∏–º –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
      isRussianUser = detectRussianUser();
      if(isRussianUser){
        console.log('üá∑üá∫ Russian user detected, enabling TURN mode');
        setStatus('–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ –†–§ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º TURN —Å–µ—Ä–≤–µ—Ä—ã‚Ä¶');
        relayMode = true;
      }

      try {
        console.log('üì° Loading TURN servers...');
        await loadTurn();

        console.log('üé• Initializing media...');
        await initMedia();

        console.log('üîó Creating peer connection...');
        createPeer();

        console.log('üåê Connecting to signaling server...');
        ws=new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}`);
        ws.onopen=()=>{
          console.log('‚úÖ WebSocket connected, joining room...');
          send('join',{roomId,token});
          setStatus('–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ‚Ä¶');
        };

      } catch (error) {
        console.error('‚ùå Start failed:', error);
        // –ï—Å–ª–∏ initMedia –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –Ω–æ createPeer/WS failed, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
        if (localStream && localStream.getTracks().length > 0) {
          console.log('‚ö†Ô∏è  Media available but connection failed, continuing...');
          setStatus('–ú–µ–¥–∏–∞ –≥–æ—Ç–æ–≤—ã, –Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å');
        } else {
          throw error;
        }
      }
      ws.onmessage=async(ev)=>{
        const msg=JSON.parse(ev.data);
        switch(msg.type){
          case 'joined':
            role=msg.role;
            setStatus(role==='host'?'–í—ã –ø–µ—Ä–≤—ã–π –≤ –∫–æ–º–Ω–∞—Ç–µ. –ñ–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞‚Ä¶':'–í—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫. –ì–æ—Ç–æ–≤–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ‚Ä¶');

            // –î–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
            // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ relay —Ä–µ–∂–∏–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            if(isRussianUser || relayMode){
              connectionTimer = setTimeout(() => {
                if(pc && pc.connectionState !== 'connected' && !relaySwitchTried){
                  setStatus('–ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ TURN‚Ä¶');
                  send('force-relay',{});
                  switchToRelay();
                }
              }, 10000);
            }
            break;
          case 'peer-joined':
            setStatus('–ö –≤–∞–º –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å. –ì–æ—Ç–æ–≤–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ‚Ä¶');
            if(role==='host' && !offerStarted){
              try{
                offerStarted=true;
                const offer=await pc.createOffer();
                await pc.setLocalDescription(offer);
                send('offer',offer);
                setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ñ—Ñ–µ—Ä (host)‚Ä¶');
              }catch(e){ console.error('host offer', e); offerStarted=false; }
            }
            break;
          case 'ready':
            if(role==='guest' && !offerStarted){
              try{
                offerStarted=true;
                const offer=await pc.createOffer(); await pc.setLocalDescription(offer); send('offer',offer); setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ñ—Ñ–µ—Ä (guest)‚Ä¶');
              }catch(e){ console.error('guest offer', e); offerStarted=false; }
            }
            break;
          case 'offer':
            if(role==='host'){ await pc.setRemoteDescription(new RTCSessionDescription(msg.data)); const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); send('answer',answer); setStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç‚Ä¶'); }
            break;
          case 'answer': await pc.setRemoteDescription(new RTCSessionDescription(msg.data)); setStatus('–ò–¥—ë—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è‚Ä¶'); break;
          case 'candidate': try{ await pc.addIceCandidate(new RTCIceCandidate(msg.data.candidate)) }catch(e){ console.error('addIceCandidate',e) } break;
          case 'force-relay':
            if(!relayMode){ switchToRelay(); }
            break;
          case 'leave':
            setStatus('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–ª–æ–∂–∏–ª —Ç—Ä—É–±–∫—É.');
            cleanup(true);
            break;
          case 'full': alert('–ö–æ–º–Ω–∞—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞ –¥–≤—É–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.'); location.href='/'; break;
          case 'error': alert('–û—à–∏–±–∫–∞: '+(msg.message||'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')); break;
        }
      };
      ws.onclose=()=>setStatus('–°–∏–≥–Ω–∞–ª–∏–Ω–≥ –æ—Ç–∫–ª—é—á—ë–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
    }

    function switchToRelay(){
      try{ pc?.close(); }catch{}
      offerStarted=false; // –ø–æ–∑–≤–æ–ª–∏–º –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ
      relayMode=true; // —Ç–æ–ª—å–∫–æ TURN
      createPeer();
      (async()=>{ try{ const offer=await pc.createOffer(); await pc.setLocalDescription(offer); send('offer',offer); setStatus('–û—Ñ—Ñ–µ—Ä —á–µ—Ä–µ–∑ TURN‚Ä¶'); }catch(e){ console.error('relay offer',e) } })();
    }

    /* UI-—Å–æ—Å—Ç–æ—è–Ω–∏—è */
    function updateCamUi(){
      [camBtn,camBtnM].forEach(b=>{ if(!b)return; b.classList.toggle('off',!isCamOn); b.setAttribute('aria-pressed',String(isCamOn)); b.setAttribute('aria-label',isCamOn?'–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É':'–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É'); });
    }
    function updateMicUi(){
      [micBtn,micBtnM].forEach(b=>{ if(!b)return; b.classList.toggle('off',!isMicOn); b.setAttribute('aria-pressed',String(isMicOn)); b.setAttribute('aria-label',isMicOn?'–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω':'–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'); });
      micHint.classList.toggle('hidden', isMicOn);
    }

      async function copyLink(){ try{ await navigator.clipboard.writeText(location.href); showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞') }catch{} }
      function toggleCam(){ isCamOn=!isCamOn; localStream.getVideoTracks().forEach(t=>t.enabled=isCamOn); updateCamUi(); }
      function toggleMic(){ isMicOn=!isMicOn; localStream.getAudioTracks().forEach(t=>t.enabled=isMicOn); updateMicUi(); }
      function safeClose(){ window.close(); setTimeout(()=>{ location.href='/' },100); }
      function cleanup(remote=false){
        if(remoteVideo.srcObject){ remoteVideo.srcObject.getTracks().forEach(t=>t.stop()); remoteVideo.srcObject=null; }
        pc?.getSenders()?.forEach(s=>s.track&&s.track.stop());
        pc?.close();
        ws?.close();
        if(remote) safeClose();
      }
      function hangup(){ send('leave',{}); cleanup(false); safeClose(); }

    function bind(el,fn){ el&&el.addEventListener('click',fn) }
    bind(copyBtn,copyLink); bind(copyBtnM,copyLink);
    bind(camBtn,toggleCam); bind(camBtnM,toggleCam);
    bind(micBtn,toggleMic); bind(micBtnM,toggleMic);
    bind(hangupBtn,hangup); bind(hangupBtnM,hangup);

    function showToast(text){
      const t=document.createElement('div'); t.textContent=text;
      Object.assign(t.style,{position:'fixed',left:'50%',bottom:`calc(var(--controls-h,72px) + 16px + env(safe-area-inset-bottom))`,transform:'translateX(-50%)',background:'#1f232a',color:'#fff',border:'1px solid #ffffff33',borderRadius:'12px',padding:'10px 14px',zIndex:9,boxShadow:'0 10px 30px #0008'});
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }

    updateCamUi(); updateMicUi();
    start().catch(err=>{ console.error(err); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.') });
  </script>
</body>
</html>
