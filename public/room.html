<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="stylesheet" href="/common.css" />
  <title>Комната видеозвонка</title>
  <style>
    :root{
      color-scheme: light dark;
      --header-h:56px; --controls-h:72px; --pad:10px;

      /* ШИРИНА превью остаётся прежней, ВЫСОТА увеличена в 2 раза:
         высота = ширина * 1.125 (т.к. (9/16)*2 = 1.125) */
      --pip-w-desktop:180px;
      --pip-w-mobile:120px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0b0c;color:#fff}

    header{
      position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;justify-content:space-between;
      height:var(--header-h);padding:8px max(10px,env(safe-area-inset-right)) 8px max(10px,env(safe-area-inset-left));
      background:#111317;border-bottom:1px solid #ffffff14;
    }
    .roomid{font-size:.95rem;opacity:.85;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .actions{display:none}

    button{
      background:#1f232a;color:#fff;border:1px solid #ffffff22;padding:10px 12px;border-radius:12px;cursor:pointer;min-height:44px;
      touch-action:manipulation;display:inline-flex;align-items:center;gap:8px
    }
    button:active{transform:translateY(1px)}
    /* .btn-icon svg sizing moved to common.css */
    .danger{background:#b3261e;border-color:#b3261e}

    /* Переключение иконок on/off */
    .icon.off-ico{display:none}
    .btn-icon.off .on-ico{display:none}
    .btn-icon.off .off-ico{display:inline}

    .layout{display:grid;grid-template-columns:1fr;gap:10px;padding:var(--pad);min-height:auto;padding-bottom:calc(var(--controls-h)+8px)}
    .video-wrap{
      position:relative;background:#0e1014;border:1px solid #ffffff14;border-radius:0;
      display:grid;place-items:center;overflow:hidden;min-height:240px;
      height:calc(var(--vh,100svh) - var(--header-h) - var(--controls-h) - env(safe-area-inset-top));
      border-left:0;border-right:0
    }

    /* Видео заполняет контейнер, удалённое — без обрезки */
    video{width:100%;height:100%;object-fit:cover}
    #remoteVideo{object-fit:contain;background:#000}

    /* Локальное превью: ширина как прежде, высота = ширина * 1.125 (в 2 раза выше от исходной 16:9) */
    .local{
      position:absolute;right:12px;bottom:12px;z-index:4;
      width:var(--pip-w-mobile) !important;
      height:calc(var(--pip-w-mobile) * 1.125) !important;
      object-fit:cover;border:1px solid #ffffff2a;border-radius:12px;overflow:hidden;
      box-shadow:0 8px 30px #00000066;pointer-events:none;background:#000
    }

    /* Оверлеи */
    .overlay{position:absolute;inset:0;display:grid;place-items:center;background:#0006;backdrop-filter:blur(2px)}
    .overlay.hidden{display:none}
    .overlay button{font-size:1rem;padding:14px 18px;border-radius:14px}

    /* Плашка «Включи микрофон» */
    .mic-hint{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      background:#b3261ee6;color:#fff;border:1px solid #ffffff44;border-radius:12px;
      padding:8px 12px;font-weight:600;z-index:6;backdrop-filter:saturate(1.2) blur(2px)
    }
    .mic-hint.hidden{display:none}

    .sidebar{display:grid;grid-auto-rows:min-content;gap:10px;min-height:0}
    .card{padding:12px;background:#111317;border:1px solid #ffffff14;border-radius:14px}
    .status{font-size:.95rem;opacity:.9}

    .controls{
      position:fixed;left:0;right:0;bottom:0;z-index:6;display:block;background:#111317cc;backdrop-filter:blur(10px);
      border-top:1px solid #ffffff22;padding:8px max(10px,env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) max(10px,env(safe-area-inset-left));
      height:var(--controls-h)
    }
    .controls .row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px}
    .controls button{width:100%}

    /* Убрана узкая правая колонка на средних экранах */
    /* @media(max-width:1024px){.layout{grid-template-columns:1fr 260px}} */
    @media(max-width:900px){
      .sidebar{order:2}
      /* Компактная кнопка «Завершить» без лишнего пустого места */
      #hangupM{width:auto;justify-content:center;padding:12px;min-width:56px}
      header{border-radius:0}
      body{background:#0e1014}
    }

    button:focus-visible{outline:2px solid #7aa2ff;outline-offset:2px}
  </style>
</head>
<body>
  <header>
    <div class="roomid">Комната: <span id="roomLabel"></span></div>
    <div class="actions">
      <button id="copyLink" class="btn-icon" aria-label="Скопировать ссылку">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 0 0-7.07-7.07L10.5 5"/>
          <path d="M14 11a5 5 0 0 0-7.07 0L4.8 13.13a5 5 0 1 0 7.07 7.07L13.5 19"/>
        </svg>
        <span class="label">Скопировать</span>
      </button>

      <button id="toggleCam" class="btn-icon" aria-pressed="true" aria-label="Выключить камеру">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <path d="M17 9l5-3v12l-5-3z"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><path d="M3 7a2 2 0 0 1 2-2h7"/>
          <path d="M16 16H5a2 2 0 0 1-2-2V9"/><path d="M17 9l5-3v8"/>
        </svg>
        <span class="label">Камера</span>
      </button>

      <button id="toggleMic" class="btn-icon" aria-pressed="true" aria-label="Выключить микрофон">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><path d="M12 19v3"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10v2a7 7 0 0 0 10.5 6.1"/><path d="M12 19v3"/>
        </svg>
        <span class="label">Микрофон</span>
      </button>

      <!-- «Завершить» — ТОЛЬКО иконка, без подписи -->
      <button id="hangup" class="danger btn-icon" aria-label="Завершить звонок">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.36a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.72-1.14a2 2 0 0 1 2.11-.45c.74.25 1.54.44 2.36.57A2 2 0 0 1 22 16.92z"/>
        </svg>
      </button>
    </div>
  </header>

  <main class="layout">
    <section class="video-wrap" id="videoWrap">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" class="local" autoplay muted playsinline></video>

      <!-- Плашка «Включи микрофон» -->
      <div id="micHint" class="mic-hint hidden">Включи микрофон</div>

      <!-- Оверлей для автоплея (iOS/Safari) -->
      <div id="playOverlay" class="overlay hidden">
        <button id="startPlayback">Нажмите, чтобы начать</button>
      </div>
    </section>
    
  </main>

  <!-- Нижняя панель (мобильная) — у ВСЕХ кнопок подписи, кроме «Завершить» -->
  <nav class="controls" role="navigation" aria-label="Панель управления звонком">
    <div class="row">
      <button id="copyLinkM" class="btn-icon" aria-label="Скопировать ссылку">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10 13a5 5 0 0 0 7.07 0l2.12-2.12a5 5 0 0 0-7.07-7.07L10.5 5"/>
          <path d="M14 11a5 5 0 0 0-7.07 0L4.8 13.13a5 5 0 1 0 7.07 7.07L13.5 19"/>
        </svg>
        <span class="label">Ссылка</span>
      </button>
      <button id="toggleCamM" class="btn-icon" aria-pressed="true" aria-label="Выключить камеру">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 7a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <path d="M17 9l5-3v12l-5-3z"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><path d="M3 7a2 2 0 0 1 2-2h7"/>
          <path d="M16 16H5a2 2 0 0 1-2-2V9"/><path d="M17 9l5-3в8"/>
        </svg>
        <span class="label">Камера</span>
      </button>
      <button id="toggleMicM" class="btn-icon" aria-pressed="true" aria-label="Выключить микрофон">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 10v2a7 7 0 0 0 14 0v-2"/><path d="M12 19v3"/>
        </svg>
        <svg class="icon off-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l22 22"/><rect x="9" y="2" width="6" height="12" rx="3"/>
          <path d="M5 10v2a7 7 0 0 0 10.5 6.1"/><path d="M12 19v3"/>
        </svg>
        <span class="label">Микрофон</span>
      </button>
      <button id="hangupM" class="danger btn-icon" aria-label="Завершить звонок">
        <svg class="icon on-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.81.31 1.6.57 2.36a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.72-1.14a2 2 0 0 1 2.11-.45c.74.25 1.54.44 2.36.57A2 2 0 0 1 22 16.92z"/>
        </svg>
      </button>
    </div>
  </nav>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    const token = urlParams.get('token');
    const roomType = urlParams.get('type') || 'video';

    // DOM elements
    const roomLabel = document.getElementById('roomLabel');
    const statusEl = document.getElementById('status');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const overlay = document.getElementById('playOverlay');
    const startPlaybackBtn = document.getElementById('startPlayback');
    const micHint = document.getElementById('micHint');

    // Control buttons
    const copyBtns = [document.getElementById('copyLink'), document.getElementById('copyLinkM')];
    const camBtns = [document.getElementById('toggleCam'), document.getElementById('toggleCamM')];
    const micBtns = [document.getElementById('toggleMic'), document.getElementById('toggleMicM')];
    const hangupBtns = [document.getElementById('hangup'), document.getElementById('hangupM')];

    // State
    let ws, pc, localStream;
    let isCamOn = true, isMicOn = true;
    let isHost = false;

    // Utility functions
    function setStatus(text) {
      if (statusEl) statusEl.textContent = text;
      console.log('Status:', text);
    }

    function send(type, data = {}) {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        console.error('WebSocket not ready');
        return;
      }
      ws.send(JSON.stringify({ type, roomId, token, data }));
    }

    async function getIceServers() {
      try {
        const response = await fetch('/api/turn');
        const data = await response.json();
        return data.iceServers || [];
      } catch (e) {
        console.warn('Failed to load TURN servers:', e);
        return [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ];
      }
    }

    async function initMedia() {
      try {
        setStatus('Получаем доступ к камере и микрофону...');

        const constraints = {
          video: roomType === 'video' ? { width: 1280, height: 720 } : false,
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        };

        localStream = await navigator.mediaDevices.getUserMedia(constraints);

        if (roomType === 'video' && localVideo) {
          localVideo.srcObject = localStream;
        }

        setStatus('Медиа устройства готовы');
        return true;
      } catch (error) {
        console.error('Media access error:', error);

        let message = 'Не удалось получить доступ к ';
        if (error.name === 'NotAllowedError') {
          message += 'камере/микрофону. Разрешите доступ в настройках браузера.';
        } else if (error.name === 'NotFoundError') {
          message += 'камере/микрофону. Устройства не найдены.';
        } else {
          message += 'медиа устройствам.';
        }

        alert(message);
        throw error;
      }
    }

    function createPeerConnection() {
      const iceServers = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ];

      pc = new RTCPeerConnection({ iceServers });

      // Add local tracks
      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      // Handle remote tracks
      pc.ontrack = (event) => {
        console.log('Remote track received:', event.track.kind);
        if (remoteVideo && event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          playRemoteVideo();
        }
      };

      // Handle ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          send('candidate', { candidate: event.candidate });
        }
      };

      // Handle connection state changes
      pc.oniceconnectionstatechange = () => {
        console.log('ICE connection state:', pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected') {
          setStatus('Соединение установлено');
        } else if (pc.iceConnectionState === 'failed') {
          setStatus('Ошибка соединения');
        }
      };

      pc.onconnectionstatechange = () => {
        console.log('Connection state:', pc.connectionState);
        if (pc.connectionState === 'connected') {
          setStatus('Связь установлена');
        } else if (pc.connectionState === 'disconnected') {
          setStatus('Связь потеряна');
        } else if (pc.connectionState === 'failed') {
          setStatus('Соединение не удалось');
        }
      };

      return pc;
    }

    async function playRemoteVideo() {
      if (!remoteVideo) return;

      try {
        await remoteVideo.play();
        if (overlay) overlay.classList.add('hidden');
      } catch (error) {
        console.log('Playback failed:', error);
        if (overlay) overlay.classList.remove('hidden');
      }
    }

    async function createOffer() {
      try {
        setStatus('Создаём предложение подключения...');
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        send('offer', offer);
        setStatus('Предложение отправлено');
      } catch (error) {
        console.error('Error creating offer:', error);
        setStatus('Ошибка при создании предложения');
      }
    }

    async function handleOffer(offer) {
      try {
        setStatus('Принимаем предложение...');
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        send('answer', answer);
        setStatus('Ответ отправлен');
      } catch (error) {
        console.error('Error handling offer:', error);
        setStatus('Ошибка при обработке предложения');
      }
    }

    async function handleAnswer(answer) {
      try {
        setStatus('Принимаем ответ...');
        await pc.setRemoteDescription(new RTCSessionDescription(answer));
      } catch (error) {
        console.error('Error handling answer:', error);
        setStatus('Ошибка при обработке ответа');
      }
    }

    async function handleCandidate(candidate) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (error) {
        console.error('Error adding ICE candidate:', error);
      }
    }

    function updateCamUI() {
      camBtns.forEach(btn => {
        if (!btn) return;
        btn.classList.toggle('off', !isCamOn);
        btn.setAttribute('aria-pressed', String(isCamOn));
        btn.setAttribute('aria-label', isCamOn ? 'Выключить камеру' : 'Включить камеру');
      });
    }

    function updateMicUI() {
      micBtns.forEach(btn => {
        if (!btn) return;
        btn.classList.toggle('off', !isMicOn);
        btn.setAttribute('aria-pressed', String(isMicOn));
        btn.setAttribute('aria-label', isMicOn ? 'Выключить микрофон' : 'Включить микрофон');
      });
      if (micHint) micHint.classList.toggle('hidden', isMicOn);
    }

    // Event handlers
    async function copyLink() {
      try {
        await navigator.clipboard.writeText(window.location.href);
        showToast('Ссылка скопирована');
      } catch (error) {
        console.error('Failed to copy link:', error);
      }
    }

    function toggleCam() {
      isCamOn = !isCamOn;
      if (localStream) {
        localStream.getVideoTracks().forEach(track => {
          track.enabled = isCamOn;
        });
      }
      updateCamUI();
    }

    function toggleMic() {
      isMicOn = !isMicOn;
      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = isMicOn;
        });
      }
      updateMicUI();
    }

    function hangup() {
      send('leave');
      cleanup();
      window.location.href = '/';
    }

    function cleanup() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      if (remoteVideo && remoteVideo.srcObject) {
        remoteVideo.srcObject.getTracks().forEach(track => track.stop());
        remoteVideo.srcObject = null;
      }
      if (pc) pc.close();
      if (ws) ws.close();
    }

    function showToast(text) {
      const toast = document.createElement('div');
      toast.textContent = text;
      Object.assign(toast.style, {
        position: 'fixed',
        left: '50%',
        bottom: 'calc(72px + 16px)',
        transform: 'translateX(-50%)',
        background: '#1f232a',
        color: '#fff',
        border: '1px solid #ffffff33',
        borderRadius: '12px',
        padding: '10px 14px',
        zIndex: 9,
        boxShadow: '0 10px 30px #0008'
      });
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1200);
    }

    // Initialize the application
    async function init() {
      // Set viewport height for mobile
      function setVh() {
        const vh = window.visualViewport?.height || window.innerHeight;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }
      setVh();
      window.addEventListener('resize', setVh);
      window.addEventListener('orientationchange', setVh);

      // Validate parameters
      if (!roomId || !token) {
        alert('Неверная ссылка: отсутствует room или token.');
        window.location.href = '/';
        return;
      }

      roomLabel.textContent = roomId;

      try {
        // Initialize media
        await initMedia();

        // Create peer connection
        createPeerConnection();

        // Connect to signaling server
        setStatus('Подключаемся к серверу...');
        ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);

        ws.onopen = () => {
          console.log('WebSocket connected');
          send('join');
          setStatus('Входим в комнату...');
        };

        ws.onmessage = async (event) => {
          const msg = JSON.parse(event.data);
          console.log('Received:', msg.type, msg);

          switch (msg.type) {
            case 'joined':
              isHost = msg.role === 'host';
              setStatus(isHost ? 'Вы первый в комнате. Ждём второго участника...' : 'Второй участник. Готовим соединение...');
              break;

            case 'peer-joined':
              setStatus('К вам присоединились. Начинаем соединение...');
              if (isHost) {
                await createOffer();
              }
              break;

            case 'offer':
              await handleOffer(msg.data);
              break;

            case 'answer':
              await handleAnswer(msg.data);
              break;

            case 'candidate':
              await handleCandidate(msg.data.candidate);
              break;

            case 'leave':
              setStatus('Собеседник вышел из комнаты');
              cleanup();
              break;

            case 'full':
              alert('Комната уже занята двумя участниками.');
              window.location.href = '/';
              break;

            case 'error':
              alert('Ошибка: ' + (msg.message || 'неизвестно'));
              break;
          }
        };

        ws.onclose = () => {
          setStatus('Соединение с сервером потеряно');
        };

        // Bind event handlers
        copyBtns.forEach(btn => btn?.addEventListener('click', copyLink));
        camBtns.forEach(btn => btn?.addEventListener('click', toggleCam));
        micBtns.forEach(btn => btn?.addEventListener('click', toggleMic));
        hangupBtns.forEach(btn => btn?.addEventListener('click', hangup));

        if (startPlaybackBtn) {
          startPlaybackBtn.addEventListener('click', playRemoteVideo);
        }

        // Update UI
        updateCamUI();
        updateMicUI();

      } catch (error) {
        console.error('Initialization failed:', error);
        alert('Не удалось инициализировать приложение. Проверьте разрешения на доступ к камере и микрофону.');
      }
    }

    // Handle page unload
    window.addEventListener('beforeunload', () => {
      send('leave');
      cleanup();
    });

    // Start the application
    init();
  </script>
</body>
</html>
