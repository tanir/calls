<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Комната видеозвонка</title>
  <style>
    :root {
      color-scheme: light dark;
      --header-h: 56px;
      --controls-h: 72px;
      --pad: 10px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #0b0b0c; color: #fff; }
    header { position: sticky; top: 0; z-index: 5; display: flex; gap: 8px; align-items: center; justify-content: space-between; height: var(--header-h); padding: 8px max(10px, env(safe-area-inset-right)) 8px max(10px, env(safe-area-inset-left)); background: #111317; border-bottom: 1px solid #ffffff14; }
    .roomid { font-size: .95rem; opacity: .85; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .actions { display: flex; gap: 8px; }
    button { background: #1f232a; color: #fff; border: 1px solid #ffffff22; padding: 10px 12px; border-radius: 12px; cursor: pointer; min-height: 44px; touch-action: manipulation; }
    button:active { transform: translateY(1px); }
    .danger { background: #b3261e; border-color: #b3261e; }

    .layout { display: grid; grid-template-columns: 1fr 300px; gap: 10px; padding: var(--pad); min-height: calc(100svh - var(--header-h)); }
    .video-wrap { position: relative; background: #0e1014; border: 1px solid #ffffff14; border-radius: 16px; display: grid; place-items: center; overflow: hidden; min-height: 240px; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .local { position: absolute; right: 12px; bottom: 12px; width: min(36vw, 260px); aspect-ratio: 16/9; border: 1px solid #ffffff2a; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 30px #00000066; }

    .overlay { position: absolute; inset: 0; display: grid; place-items: center; background: #00000066; backdrop-filter: blur(2px); }
    .overlay.hidden { display: none; }
    .overlay button { font-size: 1rem; padding: 14px 18px; border-radius: 14px; }

    .sidebar { display: grid; grid-auto-rows: min-content; gap: 10px; min-height: 0; }
    .card { padding: 12px; background: #111317; border: 1px solid #ffffff14; border-radius: 14px; }
    .status { font-size: .95rem; opacity: .9; }

    .controls { position: fixed; left: 0; right: 0; bottom: 0; z-index: 6; display: none; background: #111317cc; backdrop-filter: blur(10px); border-top: 1px solid #ffffff22; padding: 8px max(10px, env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-left)); }
    .controls .row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .controls button { width: 100%; }

    @media (max-width: 1024px) { .layout { grid-template-columns: 1fr 260px; } }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; min-height: auto; padding-bottom: calc(var(--controls-h) + 8px); }
      .sidebar { order: 2; }
      .actions { display: none; }
      .controls { display: block; height: var(--controls-h); }
      .video-wrap { height: calc(var(--vh, 100svh) - var(--header-h) - var(--controls-h) - env(safe-area-inset-top)); border-radius: 0; border-left: 0; border-right: 0; }
      .local { width: min(40vw, 220px); }
      header { border-radius: 0; }
      body { background: #0e1014; }
    }

    button:focus-visible { outline: 2px solid #7aa2ff; outline-offset: 2px; }
  </style>
</head>
<body>
  <header>
    <div class="roomid">Комната: <span id="roomLabel"></span></div>
    <div class="actions">
      <button id="copyLink" aria-label="Скопировать ссылку">Скопировать ссылку</button>
      <button id="toggleCam" aria-pressed="true" aria-label="Камера вкл/выкл">Камера вкл/выкл</button>
      <button id="toggleMic" aria-pressed="true" aria-label="Микрофон вкл/выкл">Микрофон вкл/выкл</button>
      <button id="hangup" class="danger" aria-label="Завершить звонок">Завершить</button>
    </div>
  </header>

  <main class="layout">
    <section class="video-wrap" id="videoWrap">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" class="local" autoplay muted playsinline></video>

      <!-- Оверлей «тап, чтобы начать» для мобильных/автоплея -->
      <div id="playOverlay" class="overlay hidden">
        <button id="startPlayback">Нажмите, чтобы начать</button>
      </div>
    </section>
    <aside class="sidebar">
      <div class="card"><div class="status" id="status">Ожидание второго участника…</div></div>
      <div class="card"><div style="font-size:.95rem;">Поделитесь ссылкой с собеседником. Как только он зайдёт — вы моментально увидите друг друга.</div></div>
    </aside>
  </main>

  <nav class="controls" role="navigation" aria-label="Панель управления звонком">
    <div class="row">
      <button id="copyLinkM" aria-label="Скопировать ссылку">Ссылка</button>
      <button id="toggleCamM" aria-pressed="true" aria-label="Камера вкл/выкл">Камера</button>
      <button id="toggleMicM" aria-pressed="true" aria-label="Микрофон вкл/выкл">Микрофон</button>
      <button id="hangupM" class="danger" aria-label="Завершить звонок">Завершить</button>
    </div>
  </nav>

  <script>
    // ====== Высота для мобильных адресных строк ======
    function setVh() {
      const h = (window.visualViewport?.height || window.innerHeight);
      document.documentElement.style.setProperty('--vh', h + 'px');
    }
    setVh(); window.addEventListener('resize', setVh); window.addEventListener('orientationchange', setVh);

    // ====== Элементы/параметры ======
    const qs = new URLSearchParams(location.search);
    const roomId = qs.get('room');
    const roomLabel = document.getElementById('roomLabel');
    const statusEl = document.getElementById('status');
    const copyBtn = document.getElementById('copyLink');
    const camBtn = document.getElementById('toggleCam');
    const micBtn = document.getElementById('toggleMic');
    const hangupBtn = document.getElementById('hangup');
    const copyBtnM = document.getElementById('copyLinkM');
    const camBtnM = document.getElementById('toggleCamM');
    const micBtnM = document.getElementById('toggleMicM');
    const hangupBtnM = document.getElementById('hangupM');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const overlay = document.getElementById('playOverlay');
    const startPlaybackBtn = document.getElementById('startPlayback');

    roomLabel.textContent = roomId || '—';
    if (!roomId) { alert('Параметр room обязателен. Вернитесь и создайте встречу.'); location.href = '/'; }

    // ====== WebRTC / Signaling ======
    let ws, pc, localStream;
    let role = 'guest';
    let isCamOn = true, isMicOn = true;

    const iceServers = [
      { urls: ['stun:stun.l.google.com:19302'] },
      // Раскомментируйте и подставьте ваш TURN, когда будет готов:
      // { urls: 'turn:turn.example.com:3478', username: 'webrtc', credential: 'strongpassword' },
      // { urls: 'turns:turn.example.com:5349', username: 'webrtc', credential: 'strongpassword' },
    ];

    function log(...a){ console.log('[RTC]', ...a); }

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    }

    function ensurePlayback() {
      // Пытаемся запустить воспроизведение удалённого видео (мобильные/политики автоплея)
      if (!remoteVideo) return;
      const tryPlay = () => {
        remoteVideo.play().then(() => {
          overlay.classList.add('hidden');
          log('remoteVideo playing');
        }).catch(() => {
          overlay.classList.remove('hidden');
          log('remoteVideo play blocked - waiting for user gesture');
        });
      };
      tryPlay();
      remoteVideo.addEventListener('loadedmetadata', tryPlay, { once: true });
      document.addEventListener('visibilitychange', () => { if (!document.hidden) tryPlay(); });
      startPlaybackBtn.addEventListener('click', tryPlay);
    }

    function createPeer() {
      pc = new RTCPeerConnection({ iceServers });

      // Добавляем локальные треки
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      // Получаем удалённые треки
      pc.ontrack = (ev) => {
        const [stream] = ev.streams;
        if (stream) {
          // Назначаем поток, если ещё не назначен или заменился
          if (remoteVideo.srcObject !== stream) {
            remoteVideo.srcObject = stream;
            log('Remote stream attached');
            ensurePlayback();
          }
        } else {
          // fallback на объединение по track
          let rs = remoteVideo.srcObject;
          if (!rs) {
            rs = new MediaStream();
            remoteVideo.srcObject = rs;
          }
          rs.addTrack(ev.track);
          log('Remote track added (no stream in event)');
          ensurePlayback();
        }
      };

      pc.onicecandidate = (ev) => {
        if (ev.candidate) send('candidate', { candidate: ev.candidate });
      };

      pc.oniceconnectionstatechange = () => {
        log('iceConnectionState:', pc.iceConnectionState);
        if (pc.iceConnectionState === 'connected') setStatus('Медиа-канал установлен');
        if (pc.iceConnectionState === 'failed') setStatus('ICE failed — вероятно нужен TURN');
      };

      pc.onconnectionstatechange = () => {
        log('connectionState:', pc.connectionState);
        const s = pc.connectionState;
        if (s === 'connected') setStatus('Соединение установлено');
        if (s === 'disconnected' || s === 'failed') setStatus('Связь потеряна. Обновите страницу или включите TURN.');
      };
    }

    function setStatus(text) { statusEl.textContent = text; }
    function send(type, data) { ws?.send(JSON.stringify({ type, data, roomId })); }

    async function start() {
      await initMedia();
      createPeer();

      ws = new WebSocket(`${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`);
      ws.onopen = () => { send('join', { roomId }); setStatus('Подключаемся к комнате…'); };
      ws.onmessage = async (ev) => {
        const msg = JSON.parse(ev.data);
        switch (msg.type) {
          case 'joined':
            role = msg.role;
            setStatus(role === 'host' ? 'Вы первый в комнате. Ждём второго участника…' : 'Второй участник. Готовим соединение…');
            break;

          case 'peer-joined':
            setStatus('К вам присоединились. Готовим соединение…');
            break;

          case 'ready':
            // Второй участник инициирует оффер
            if (role === 'guest') {
              const offer = await pc.createOffer();
              await pc.setLocalDescription(offer);
              send('offer', offer);
              log('Offer sent');
              setStatus('Отправлен оффер…');
            }
            break;

          case 'offer':
            if (role === 'host') {
              await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              send('answer', answer);
              log('Answer sent');
              setStatus('Отправлен ответ…');
            }
            break;

          case 'answer':
            await pc.setRemoteDescription(new RTCSessionDescription(msg.data));
            setStatus('Идёт установление соединения…');
            break;

          case 'candidate':
            try {
              await pc.addIceCandidate(new RTCIceCandidate(msg.data.candidate));
            } catch (e) {
              console.error('addIceCandidate error', e);
            }
            break;

          case 'leave':
            setStatus('Собеседник покинул комнату.');
            if (remoteVideo.srcObject) { remoteVideo.srcObject.getTracks().forEach(t => t.stop()); remoteVideo.srcObject = null; }
            break;

          case 'full':
            alert('Комната уже занята двумя участниками.');
            location.href = '/';
            break;

          case 'error':
            alert('Ошибка: ' + (msg.message || 'неизвестно'));
            break;
        }
      };
      ws.onclose = () => setStatus('Сигналинг отключён. Перезагрузите страницу.');
    }

    // ====== Кнопки (десктоп и мобильные дубликаты) ======
    async function copyLink() {
      try { await navigator.clipboard.writeText(location.href); showToast('Ссылка скопирована'); } catch {}
    }
    function toggleCam() {
      isCamOn = !isCamOn;
      localStream.getVideoTracks().forEach(t => t.enabled = isCamOn);
      camBtn?.setAttribute('aria-pressed', String(isCamOn));
      camBtnM?.setAttribute('aria-pressed', String(isCamOn));
      camBtn && (camBtn.textContent = isCamOn ? 'Камера выкл' : 'Камера вкл');
      camBtnM && (camBtnM.textContent = 'Камера');
    }
    function toggleMic() {
      isMicOn = !isMicOn;
      localStream.getAudioTracks().forEach(t => t.enabled = isMicOn);
      micBtn?.setAttribute('aria-pressed', String(isMicOn));
      micBtnM?.setAttribute('aria-pressed', String(isMicOn));
      micBtn && (micBtn.textContent = isMicOn ? 'Микрофон выкл' : 'Микрофон вкл');
      micBtnM && (micBtnM.textContent = 'Микрофон');
    }
    function hangup() {
      send('leave', {});
      pc?.getSenders()?.forEach(s => s.track && s.track.stop());
      pc?.close();
      ws?.close();
      location.href = '/';
    }
    function bind(btn, handler) { btn && btn.addEventListener('click', handler); }
    bind(copyBtn,  copyLink);  bind(copyBtnM,  copyLink);
    bind(camBtn,   toggleCam); bind(camBtnM,   toggleCam);
    bind(micBtn,   toggleMic); bind(micBtnM,   toggleMic);
    bind(hangupBtn, hangup);   bind(hangupBtnM, hangup);

    function showToast(text) {
      const t = document.createElement('div');
      t.textContent = text;
      Object.assign(t.style, {
        position: 'fixed', left: '50%', bottom: `calc(var(--controls-h) + 16px + env(safe-area-inset-bottom))`,
        transform: 'translateX(-50%)', background: '#1f232a', color: '#fff',
        border: '1px solid #ffffff33', borderRadius: '12px', padding: '10px 14px',
        zIndex: 9, boxShadow: '0 10px 30px #0008'
      });
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1200);
    }

    // Старт
    start().catch(err => {
      console.error(err);
      alert('Не удалось получить доступ к камере/микрофону. Проверьте разрешения.');
    });
  </script>
</body>
</html>
